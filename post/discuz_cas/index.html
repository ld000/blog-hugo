<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>discuz 接入 cas - ld000</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="ld000" /><meta name="description" content="discuz 接入 cas 实现 SSO 的方法。
" /><meta name="keywords" content="Hugo, theme, even, java, ld000" />






<meta name="generator" content="Hugo 0.60.0-DEV with theme even" />


<link rel="canonical" href="https://ld000.space/post/discuz_cas/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="discuz 接入 cas" />
<meta property="og:description" content="discuz 接入 cas 实现 SSO 的方法。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ld000.space/post/discuz_cas/" />
<meta property="article:published_time" content="2018-07-23T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-07-23T00:00:00+00:00" />
<meta itemprop="name" content="discuz 接入 cas">
<meta itemprop="description" content="discuz 接入 cas 实现 SSO 的方法。">


<meta itemprop="datePublished" content="2018-07-23T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2018-07-23T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="1202">



<meta itemprop="keywords" content="discuz,cas," />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="discuz 接入 cas"/>
<meta name="twitter:description" content="discuz 接入 cas 实现 SSO 的方法。"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">ld000</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">首页</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">归档</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">标签</li>
      </a><a href="/links/">
        <li class="mobile-menu-item">友链</li>
      </a><a href="/about/">
        <li class="mobile-menu-item">关于</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">ld000</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">首页</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">归档</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">标签</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/links/">友链</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/about/">关于</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">discuz 接入 cas</h1>

      <div class="post-meta">
        <span class="post-time"> 2018-07-23 </span>
        
        <span id="busuanzi_container_page_pv" class="more-meta"> <span id="busuanzi_value_page_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次阅读 </span>
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">文章目录</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#版本">版本</a></li>
<li><a href="#下载-casphp-插件">下载 casPHP 插件</a></li>
<li><a href="#去除登录输入">去除登录输入</a></li>
<li><a href="#去除弹框登录">去除弹框登录</a></li>
<li><a href="#在-cas-文件夹中创建-casclientconfig-php">在<code>CAS</code>文件夹中创建 <code>CasClientConfig.php</code></a></li>
<li><a href="#在-cas-文件夹中创建-casclient-php">在<code>CAS</code>文件夹中创建 <code>CasClient.php</code></a></li>
<li><a href="#source-class-class-core-php第16行加入">source/class/class_core.php第16行加入</a></li>
<li><a href="#uc-client-control-user-php">uc_client/control/user.php</a></li>
<li><a href="#source-function-function-member-php-加入">source/function/function_member.php 加入</a></li>
<li><a href="#source-class-class-member-php">source/class/class_member.php</a></li>
<li><a href="#source-module-member-member-logging-php-添加允许-logincheck-方法通过">source/module/member/member_logging.php 添加允许 <code>loginCheck</code> 方法通过</a></li>
<li><a href="#额外配置-可选">额外配置，可选</a>
<ul>
<li><a href="#自动https-http">自动https/http</a></li>
<li><a href="#关闭gateway">关闭gateway</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <p>discuz 接入 cas 实现 SSO 的方法。</p>

<h2 id="版本">版本</h2>

<ul>
<li>Discuz 3.3</li>
<li>Cas 5.x</li>
</ul>

<h2 id="下载-casphp-插件">下载 casPHP 插件</h2>

<p><code>http://developer.jasig.org/cas-clients/php/</code></p>

<p>我这里用的 1.3.0，下载完后解压拷贝到 discuz 根目录，重命名为 <code>CAS</code>。</p>

<h2 id="去除登录输入">去除登录输入</h2>

<p>修改 <code>template/default/member/login_simple.htm</code></p>

<ul>
<li><p>删除8-29行代码，删除31-32行代码</p></li>

<li><p>添加以下代码，支持访问时 force 登录.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-sh" data-lang="sh"><span class="c1"># 需要 CAS 打开允许 iframe, 否则报错: Refused to display &#39;URL&#39; in a frame because it set &#39;X-Frame-Options&#39; to &#39;DENY&#39;</span>
<span class="c1"># cas 配置：cas.httpWebRequest.header.xframe=false</span>
&lt;script <span class="nv">type</span><span class="o">=</span><span class="s2">&#34;text/javascript&#34;</span>&gt;
<span class="o">(</span><span class="k">function</span> <span class="o">()</span> <span class="o">{</span>
   var <span class="nv">_body</span> <span class="o">=</span> document.body <span class="o">||</span> document.getElementsByTagName<span class="o">(</span><span class="s1">&#39;body&#39;</span><span class="o">)[</span><span class="m">0</span><span class="o">]</span><span class="p">;</span>
   var <span class="nv">iframe</span> <span class="o">=</span> document.createElement<span class="o">(</span><span class="s1">&#39;iframe&#39;</span><span class="o">)</span><span class="p">;</span>
   iframe.id <span class="o">=</span> <span class="s1">&#39;logcheck&#39;</span><span class="p">;</span>

   iframe.src <span class="o">=</span> <span class="s2">&#34;member.php?&#34;</span>+<span class="o">((</span><span class="s2">&#34;mod=logging&amp;action=loginCheck&#34;</span><span class="o">))</span><span class="p">;</span>
   iframe.style.display <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">;</span>
   _body.appendChild<span class="o">(</span>iframe<span class="o">)</span><span class="p">;</span>
<span class="o">})()</span><span class="p">;</span>
&lt;/script&gt;

<span class="c1"># TODO 现只能在 CAS 登录后才能登录，需做修改</span></code></pre></td></tr></table>
</div>
</div></li>
</ul>

<h2 id="去除弹框登录">去除弹框登录</h2>

<p>管理中心 -&gt; 界面 -&gt; 去掉浮动窗口（登录）</p>

<p><img src="/img/discuz-cas-1.png" alt="image" /></p>

<h2 id="在-cas-文件夹中创建-casclientconfig-php">在<code>CAS</code>文件夹中创建 <code>CasClientConfig.php</code></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="nx">define</span> <span class="p">(</span> <span class="s1">&#39;CAS_SERVER_HOSTNAME&#39;</span><span class="p">,</span> <span class="s1">&#39;cas.com&#39;</span> <span class="p">);</span>
<span class="nx">define</span> <span class="p">(</span> <span class="s1">&#39;CAS_SERVER_PORT&#39;</span><span class="p">,</span> <span class="mi">8080</span> <span class="p">);</span> 
<span class="nx">define</span> <span class="p">(</span> <span class="s1">&#39;CAS_SERVER_APP_NAME&#39;</span><span class="p">,</span> <span class="s2">&#34;cas&#34;</span> <span class="p">);</span> 
<span class="cp">?&gt;</span>
</code></pre></td></tr></table>
</div>
</div>
<h2 id="在-cas-文件夹中创建-casclient-php">在<code>CAS</code>文件夹中创建 <code>CasClient.php</code></h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="cp">&lt;?php</span>
<span class="k">require_once</span> <span class="nx">DISCUZ_ROOT</span><span class="o">.</span><span class="s1">&#39;./CAS/CasClientConfig.php&#39;</span><span class="p">;</span> <span class="c1">// 注意
</span><span class="c1"></span><span class="k">require_once</span> <span class="nx">DISCUZ_ROOT</span><span class="o">.</span><span class="s1">&#39;./CAS/CAS.php&#39;</span><span class="p">;</span> <span class="c1">// 注意
</span><span class="c1"></span>                                                  
<span class="c1">// 初始化
</span><span class="c1">//phpCAS::setDebug ();
</span><span class="c1"></span> 
<span class="c1">// initialize phpCAS
</span><span class="c1"></span><span class="nx">phpCAS</span><span class="o">::</span><span class="na">client</span> <span class="p">(</span> <span class="nx">CAS_VERSION_2_0</span><span class="p">,</span> <span class="nx">CAS_SERVER_HOSTNAME</span><span class="p">,</span> <span class="nx">CAS_SERVER_PORT</span><span class="p">,</span> <span class="nx">CAS_SERVER_APP_NAME</span> <span class="p">);</span>
 
<span class="c1">// no SSL validation for the CAS server
</span><span class="c1"></span><span class="nx">phpCAS</span><span class="o">::</span><span class="na">setNoCasServerValidation</span> <span class="p">();</span>

<span class="nx">phpCAS</span><span class="o">::</span><span class="na">setNoClearTicketsFromUrl</span> <span class="p">();</span>
<span class="nx">phpCAS</span><span class="o">::</span><span class="na">handleLogoutRequests</span><span class="p">();</span>

<span class="cp">?&gt;</span>
</code></pre></td></tr></table>
</div>
</div>
<h2 id="source-class-class-core-php第16行加入">source/class/class_core.php第16行加入</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">require_once DISCUZ_ROOT.&#34;CAS/CasClient.php&#34;;</code></pre></td></tr></table>
</div>
</div>
<h2 id="uc-client-control-user-php">uc_client/control/user.php</h2>

<p>134行注释</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">// elseif($user[&#39;password&#39;] != md5($passwordmd5.$user[&#39;salt&#39;])) {
// $status = -2;
// } elseif($checkques <span class="err">&amp;&amp;</span> $user[&#39;secques&#39;] != $_ENV[&#39;user&#39;]-&gt;quescrypt($questionid, $answer)) {
// $status = -3;
// }</code></pre></td></tr></table>
</div>
</div>
<p>注释 <code>onsynlogin</code>, <code>onsynlogout</code>, <code>onregister</code>方法</p>

<h2 id="source-function-function-member-php-加入">source/function/function_member.php 加入</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">// 新加的方法，用以支持CAS 登录
function userloginCas($username, $ip = &#39;&#39;) {
    $return = array ();
    
    if(!function_exists(&#39;uc_user_login&#39;)) {
        loaducenter();
    }

    $return[&#39;ucresult&#39;] = uc_user_login(addslashes($username), &#39;&#39;, 0, 0,&#39;&#39;, &#39;&#39;, $ip);

    $tmp = array ();
    $duplicate = &#39;&#39;;
    list ( $tmp [&#39;uid&#39;], $tmp [&#39;username&#39;], $tmp [&#39;password&#39;], $tmp [&#39;email&#39;], $duplicate ) = $return [&#39;ucresult&#39;];
    $return [&#39;ucresult&#39;] = $tmp;
    if ($duplicate <span class="err">&amp;&amp;</span> $return [&#39;ucresult&#39;] [&#39;uid&#39;] &gt; 0 || $return [&#39;ucresult&#39;] [&#39;uid&#39;] <span class="err">&lt;</span>= 0) {
        $return [&#39;status&#39;] = 0;
        return $return;
    }
    
    $member = getuserbyuid ( $return [&#39;ucresult&#39;] [&#39;uid&#39;], 1 );
    if (! $member || empty ( $member [&#39;uid&#39;] )) {
        $return [&#39;status&#39;] = - 1;
        return $return;
    }
    $return [&#39;member&#39;] = $member;
    $return [&#39;status&#39;] = 1;
    if ($member [&#39;_inarchive&#39;]) {
        C::t ( &#39;common_member_archive&#39; )-&gt;move_to_master ( $member [&#39;uid&#39;] );
    }
    if ($member [&#39;email&#39;] != $return [&#39;ucresult&#39;] [&#39;email&#39;]) {
        C::t ( &#39;common_member&#39; )-&gt;update ( $return [&#39;ucresult&#39;] [&#39;uid&#39;], array (
                &#39;email&#39; =&gt; $return [&#39;ucresult&#39;] [&#39;email&#39;] 
        ) );
    }
    
    return $return;
}</code></pre></td></tr></table>
</div>
</div>
<h2 id="source-class-class-member-php">source/class/class_member.php</h2>

<p>51行注释并改为</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">// if(!submitcheck(&#39;loginsubmit&#39;, 1, $seccodestatus)) {
if (1 == 2) {</code></pre></td></tr></table>
</div>
</div>
<p>92行 <code>$_G['username'] = $_G['member']['username'] = $_G['member']['password'] = ''</code> 后加入</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">phpCAS::setNoClearTicketsFromUrl ();
// 这里会检测服务器端的退出的通知，就能实现php和其他语言平台间同步登出了  
phpCAS::handleLogoutRequests();  
$username=&#39;&#39;;
if(phpCAS::isAuthenticated()){  
    $username = phpCAS::getUser ();
} else {
    $service =  $_SERVER[&#39;HTTP_REFERER&#39;];
    phpCAS::setServerLoginUrl(phpCAS::getServerLoginURL().urlencode(&#34;?service=&#34;.$service));

    phpCAS::forceAuthentication ();
}
// if(!$_GET[&#39;password&#39;] || $_GET[&#39;password&#39;] != addslashes($_GET[&#39;password&#39;])) {
// showmessage(&#39;profile_passwd_illegal&#39;);
// }
// $result = userlogin($_GET[&#39;username&#39;], $_GET[&#39;password&#39;], $_GET[&#39;questionid&#39;], $_GET[&#39;answer&#39;], $this-&gt;setting[&#39;autoidselect&#39;] ? &#39;auto&#39; : $_GET[&#39;loginfield&#39;], $_G[&#39;clientip&#39;]);
$result = userloginCas($username, $_G[&#39;clientip&#39;]);</code></pre></td></tr></table>
</div>
</div>
<p>347行 <code>on_logout</code> 方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">if(defined(&#39;IN_MOBILE&#39;)) {
    showmessage(&#39;location_logout_succeed_mobile&#39;, dreferer(), array(&#39;formhash&#39; =&gt; FORMHASH, &#39;referer&#39; =&gt; rawurlencode(dreferer())));
} else {
    $service =  $_SERVER[&#39;HTTP_REFERER&#39;];
    phpCAS::logoutWithRedirectService ( $service );
// showmessage(&#39;logout_succeed&#39;, dreferer(), array(&#39;formhash&#39; =&gt; FORMHASH, &#39;ucsynlogout&#39; =&gt; $ucsynlogout, &#39;referer&#39; =&gt; rawurlencode(dreferer())));
}</code></pre></td></tr></table>
</div>
</div>
<p>386行 <code>on_register</code>方法中</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">if(strpos($url_forward, $this-&gt;setting[&#39;regname&#39;]) !== false) {
    $url_forward = &#39;forum.php&#39;;
}
// 修改掉防止当登录成功时无限跳转
$url_forward = &#39;forum.php&#39;;</code></pre></td></tr></table>
</div>
</div>
<p><code>logging_ctl</code>类中 添加异步登录验证方法</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php"><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-php" data-lang="php">function on_loginCheck(){
    global $_G;
    $username=&#39;&#39;;
    if(phpCAS::isAuthenticated()){
        $username = phpCAS::getUser ();
    } else {
        phpCAS::setServerLoginUrl(phpCAS::getServerLoginURL());
        phpCAS::forceAuthentication ();
    }
    $result = userloginCas($username, $_G[&#39;clientip&#39;]);

    if($data = uc_get_user($username)) {
        list($uid, $username, $email) = $data;      //根据用户名获取uid进行登录
    } else {
        dexit();
    }

    if($uid &gt; 0) {
        $member = getuserbyuid($uid, 1);            //根据uid获取用户表pre_common_member中的所有字段

        $_G[&#39;uid&#39;] = intval($uid);
        $_G[&#39;username&#39;] = $username;
        $_G[&#39;adminid&#39;] = $member[&#39;adminid&#39;];
        $_G[&#39;groupid&#39;] = $member[&#39;groupid&#39;];
        $_G[&#39;formhash&#39;] = formhash();
        $_G[&#39;session&#39;][&#39;invisible&#39;] = getuserprofile(&#39;invisible&#39;);
        $_G[&#39;member&#39;] = $member;
        loadcache(&#39;usergroup_&#39;.$_G[&#39;groupid&#39;]);
        C::app()-&gt;session-&gt;isnew = true;
        C::app()-&gt;session-&gt;updatesession();

        dsetcookie(&#39;auth&#39;, authcode(&#34;{$member[&#39;password&#39;]}\t{$member[&#39;uid&#39;]}&#34;, &#39;ENCODE&#39;), $cookietime, 1, true);        //这里的passwod是pre_common_member表中经过加密后的密码
        dsetcookie(&#39;loginuser&#39;,$username);
        dsetcookie(&#39;activationauth&#39;);
        dsetcookie(&#39;pmnum&#39;);

        dexit(&#39;<span class="p">&lt;</span><span class="nt">script</span> <span class="na">type</span><span class="o">=</span><span class="s">&#34;text/javascript&#34;</span><span class="p">&gt;</span><span class="nb">window</span><span class="p">.</span><span class="nx">top</span><span class="p">.</span><span class="nx">location</span><span class="p">.</span><span class="nx">reload</span><span class="p">();&lt;/</span><span class="nt">script</span><span class="p">&gt;</span>&#39;);
    } else {
        dexit();
    }
}</code></pre></td></tr></table>
</div>
</div>
<h2 id="source-module-member-member-logging-php-添加允许-logincheck-方法通过">source/module/member/member_logging.php 添加允许 <code>loginCheck</code> 方法通过</h2>

<p>第15行改为 <code>if(!in_array($_GET['action'], array('login', 'logout','loginCheck')))</code></p>

<h2 id="额外配置-可选">额外配置，可选</h2>

<h3 id="自动https-http">自动https/http</h3>

<p><code>CAS/CAS/Client.php</code></p>

<p>299行
<code>$this-&gt;_server['base_url'] = 'https://' . $this-&gt;_getServerHostname();</code>
改为
<code>$this-&gt;_server['base_url'] = ($this-&gt;_isHttps() ? 'https':'http').'://'. $this-&gt;_getServerHostname();</code></p>

<h3 id="关闭gateway">关闭gateway</h3>

<p><code>CAS/CAS/Client.php</code></p>

<p>1164行
<code>$this-&gt;redirectToCas(true/* gateway */);</code>
改为
<code>$this-&gt;redirectToCas(false/* gateway */);</code></p>
    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">文章作者</span>
    <span class="item-content">ld000</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">上次更新</span>
    <span class="item-content">
        2018-07-23
        
    </span>
  </p>
  
  
</div>
<div class="post-reward">
  <input type="checkbox" name="reward" id="reward" hidden />
  <label class="reward-button" for="reward">赞赏支持</label>
  <div class="qr-code">
    
    <label class="qr-code-image" for="reward">
        <img class="image" src="/WechatIMG1.jpeg">
        <span>微信打赏</span>
      </label>
    <label class="qr-code-image" for="reward">
        <img class="image" src="/WechatIMG2.jpeg">
        <span>支付宝打赏</span>
      </label>
  </div>
</div><footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/discuz/">discuz</a>
          <a href="/tags/cas/">cas</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/automator_brewfile/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">MacOS 用 automater 自动备份安装的软件列表</span>
            <span class="prev-text nav-mobile">上一篇</span>
          </a>
        <a class="next" href="/post/java_call_cnet/">
            <span class="next-text nav-default">java 调用 c# 的方法</span>
            <span class="next-text nav-mobile">下一篇</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        <div id="disqus_thread"></div>
    <script type="text/javascript">
    (function() {
      
      
      if (window.location.hostname === 'localhost') return;

      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      var disqus_shortname = 'ld000-1';
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:lidong9144@163.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/ld000" class="iconfont icon-github" title="github"></a>
  <a href="https://ld000.space/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://gohugo.io">Hugo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  <div class="busuanzi-footer">
    <span id="busuanzi_container_site_pv"> 本站总访问量 <span id="busuanzi_value_site_pv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 次 </span>
      <span class="division">|</span>
    <span id="busuanzi_container_site_uv"> 本站总访客数 <span id="busuanzi_value_site_uv"><img src="/img/spinner.svg" alt="spinner.svg"/></span> 人 </span>
  </div>

  <span class="copyright-year">
    &copy; 
    2017 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">ld000</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-89678066-1', 'auto');
	ga('set', 'anonymizeIp', true);
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>







</body>
</html>
